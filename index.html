<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Conquistas de Jogos</title>
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
    }
	
    

    h1 {
      text-align: center;
    }

    .game-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .achievement-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 20px;
    }


.game-card {
  background: #1e1e1e;
  border-radius: 3px;
  text-align: center;
  cursor: pointer;
  overflow: hidden;
  width: 200px;
  margin: auto;	
}


.game-card img {
  width: 100%;
  height: auto;
  display: block;
}

.game-title {
  padding: 10px;
  font-weight: bold;
  background: #2a2a2a;
  font-size: 0.95rem;
}

    .achievement {
      background: #1e1e1e;
      border-radius: 3px;
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 0 8px #00000055;
    }

    .achievement img {
      width: 64px;
      height: 64px;
      border-radius: 3px;
    }

    .achievement-info {
      flex: 1;
    }

    .achievement-title {
      font-weight: bold;
      font-size: 1.1rem;
    }

    .achievement-desc {
      font-size: 0.9rem;
      color: #ccc;
    }

    .progress-bar {
      margin-top: 5px;
      height: 8px;
      background: #333;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #00ff88;
    }

    #backButton {
      font-size: larger;
      margin: 20px 0;
      background: #4f4f4f;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      display: none;
      
    }

footer {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: #1a1a1a;
  border-top: 1px solid #333;
  padding: 10px 0;
  text-align: center;
  z-index: 100;
  box-shadow: 0 -2px 5px rgba(0,0,0,0.5);
}

#exportBtn,
#importLabel {
  background: #4f4f4f;
  color: white;
  padding: 8px 16px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  margin: 0 10px;
  font-size: 0.95rem;
}


@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.fade-in {
  animation: fadeIn 0.4s ease forwards;
}

  </style>
</head>
<body>
  <h1>Conquistas de Jogos - Marcos</h1>
  <button id="backButton">Voltar</button>	
  <div id="gameView" class="game-list"></div>
  <div id="achievementView" class="achievement-list" style="display: none;"></div>
  <footer id="footer">
  <button id="exportBtn">üíæ Exportar Conquistas</button>
  <input type="file" id="importFile" style="display: none;" />
  <label for="importFile" id="importLabel">üìÇ Importar Conquistas</label>
  </footer>

  
  <script>
    const ws = new WebSocket("ws://localhost:8082");
    const gameView = document.getElementById("gameView");
    const achievementView = document.getElementById("achievementView");
    const backButton = document.getElementById("backButton");

    const conquistasPorJogo = {};

    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        const appID = data.appID;
        const game = data.game;

        if (!conquistasPorJogo[appID]) {
          conquistasPorJogo[appID] = {
            game,
            icon: data.icon,
            conquistas: []
          };
          renderGames();
        }

        conquistasPorJogo[appID].conquistas.push(data);

        if (
          achievementView.style.display === "grid" &&
          achievementView.dataset.appID === String(appID)
        ) {
          renderConquistas(appID);
        }
      } catch (e) {
        console.error("Erro ao processar conquista:", e);
      }
    };

    function renderGames() {
      gameView.innerHTML = "";

      for (const appID in conquistasPorJogo) {
        const jogo = conquistasPorJogo[appID];
        const card = document.createElement("div");
        card.onclick = () => openGame(appID);

        const img = document.createElement("img");
        img.src = `https://cdn.cloudflare.steamstatic.com/steam/apps/${appID}/library_600x900.jpg`;

        const title = document.createElement("div");
        title.className = "game-title";
        title.textContent = jogo.game;

        card.appendChild(img);
        card.appendChild(title);
        gameView.appendChild(card);
	card.classList.add("game-card", "fade-in");
      }	
    }

    function openGame(appID) {
      gameView.style.display = "none";
      achievementView.style.display = "grid";
      backButton.style.display = "inline-block";
      achievementView.dataset.appID = appID;
      renderConquistas(appID);
    }

function renderConquistas(appID) {
  const jogo = conquistasPorJogo[appID];
  const container = achievementView;

  container.innerHTML = ""; // üëà Limpamos as conquistas anteriores

  const conquistasAdicionadas = new Set();

  jogo.conquistas.forEach(data => {
    // Evita duplicadas dentro do mesmo render
    if (conquistasAdicionadas.has(data.achievement)) return;
    conquistasAdicionadas.add(data.achievement);

    const box = document.createElement("div");
    box.className = "achievement fade-in"; // Aplica fade-in aqui
    box.dataset.achievementId = data.achievement;

    const img = document.createElement("img");
    img.src = data.icon || "https://via.placeholder.com/64";

    const info = document.createElement("div");
    info.className = "achievement-info";

    const title = document.createElement("div");
    title.className = "achievement-title";
    title.textContent = data.displayName;

    const desc = document.createElement("div");
    desc.className = "achievement-desc";
    desc.textContent = data.description || "Sem descri√ß√£o";

    info.appendChild(title);
    info.appendChild(desc);

    if (data.progress) {
      const bar = document.createElement("div");
      bar.className = "progress-bar";
      const fill = document.createElement("div");
      fill.className = "progress-fill";
      fill.style.width = `${(data.progress.current / data.progress.max) * 100}%`;
      bar.appendChild(fill);
      info.appendChild(bar);
    }

    box.appendChild(img);
    box.appendChild(info);
    container.appendChild(box);
  });
}


    backButton.onclick = () => {
      gameView.style.display = "grid";
      achievementView.style.display = "none";
      backButton.style.display = "none";
    };

  // Salvar conquistas localmente
  function salvarLocal() {
    localStorage.setItem("conquistas", JSON.stringify(conquistasPorJogo));
  }

  // Carregar conquistas ao iniciar
  function carregarLocal() {
    const salvo = localStorage.getItem("conquistas");
    if (salvo) {
      try {
        const data = JSON.parse(salvo);
        Object.assign(conquistasPorJogo, data);
        renderGames();
      } catch (e) {
        console.error("Erro ao carregar dados locais:", e);
      }
    }
  }

  // Exportar JSON
  document.getElementById("exportBtn").onclick = () => {
    const data = JSON.stringify(conquistasPorJogo, null, 2);
    const blob = new Blob([data], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "conquistas-backup.json";
    a.click();

    URL.revokeObjectURL(url);
  };

  // Importar JSON
  document.getElementById("importFile").addEventListener("change", function () {
    const file = this.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (event) {
      try {
        const data = JSON.parse(event.target.result);
        Object.assign(conquistasPorJogo, data);
        localStorage.setItem("conquistas", JSON.stringify(conquistasPorJogo));
        renderGames();
        alert("Conquistas importadas com sucesso!");
      } catch (e) {
        alert("Erro ao importar arquivo.");
      }
    };
    reader.readAsText(file);
  });

  // Chamar ao carregar a p√°gina
  carregarLocal();

  // Salvar sempre que receber novas conquistas
  ws.onmessage = (event) => {
    try {
      const data = JSON.parse(event.data);
      const appID = data.appID;
      const game = data.game;

      if (!conquistasPorJogo[appID]) {
        conquistasPorJogo[appID] = {
          game,
          icon: data.icon,
          conquistas: []
        };
        renderGames();
      }

      conquistasPorJogo[appID].conquistas.push(data);
      salvarLocal(); // ‚Üê Salva localmente ap√≥s novo dado

      if (
        achievementView.style.display === "grid" &&
        achievementView.dataset.appID === String(appID)
      ) {
        renderConquistas(appID);
      }
    } catch (e) {
      console.error("Erro ao processar conquista:", e);
    }
  };
  </script>
</body>
</html>
