<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Conquistas de Jogos</title>
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
      padding-bottom: 100px; /* altura do footer */
    }
	
    

    h1 {
      text-align: center;
    }

    .game-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .achievement-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 20px;
    }

.achievement-timestamp {
  font-size: 0.8rem;
  color: #aaa;
  margin-top: 6px;
}


.game-card {
  background: #1e1e1e;
  border-radius: 3px;
  text-align: center;
  cursor: pointer;
  overflow: hidden;
  width: 200px;
  margin: auto;	
}


.game-card img {
  width: 100%;
  height: auto;
  display: block;
}

.game-title {
  padding: 10px;
  font-weight: bold;
  background: #2a2a2a;
  font-size: 0.95rem;
}

    .achievement {
      background: #1e1e1e;
      border-radius: 3px;
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 0 8px #00000055;
    }

    .achievement img {
      width: 64px;
      height: 64px;
      border-radius: 3px;
    }

    .achievement-info {
      flex: 1;
    }

    .achievement-title {
      font-weight: bold;
      font-size: 1.1rem;
    }

    .achievement-desc {
      font-size: 0.9rem;
      color: #ccc;
    }

    .progress-bar {
      margin-top: 5px;
      height: 8px;
      background: #333;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #00ff88;
    }

    #backButton {
      font-size: larger;
      margin: 20px 0;
      background: #4f4f4f;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      display: none;
      
    }

footer {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: #222;
  color: white;
  text-align: center;
  padding: 10px 0 0 0;
  height: 45px;
  z-index: 10;
}


#exportBtn,
#importLabel {
  background: #4f4f4f;
  color: white;
  padding: 8px 16px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  margin: 0 10px;
  font-size: 0.95rem;
}


@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.fade-in {
  animation: fadeIn 0.4s ease forwards;
}

  </style>
</head>
<body>
  <h1>Conquistas de Jogos</h1>
  <button id="backButton">Voltar</button>	
  <div id="gameView" class="game-list"></div>
  <div id="achievementView" class="achievement-list" style="display: none;"></div>
  <footer id="footer">
  <button id="exportBtn">ðŸ’¾ Exportar Conquistas</button>
  <input type="file" id="importFile" style="display: none;" />
  <label for="importFile" id="importLabel">ðŸ“‚ Importar Conquistas</label>
  </footer>

  
  <script>
    const ws = new WebSocket("ws://localhost:8082");
    const gameView = document.getElementById("gameView");
    const achievementView = document.getElementById("achievementView");
    const backButton = document.getElementById("backButton");

    const conquistasPorJogo = {};

    ws.onmessage = (event) => {
  try {
    const data = JSON.parse(event.data);
    console.log("ðŸ“© Mensagem recebida via WebSocket:", data);
    const appID = data.appID;
    const game = data.game;

    if (!conquistasPorJogo[appID]) {
      conquistasPorJogo[appID] = {
        game,
        icon: data.icon,
        conquistas: []
      };
      renderGames();
    }

    conquistasPorJogo[appID].conquistas.push(data);
    salvarLocal(); // Salva localmente apÃ³s novo dado

    if (
      achievementView.style.display === "grid" &&
      achievementView.dataset.appID === String(appID)
    ) {
      renderConquistas(appID);
    }
  } catch (e) {
    console.error("Erro ao processar conquista:", e);
  }
};


    function renderGames() {
      gameView.innerHTML = "";

      for (const appID in conquistasPorJogo) {
        const jogo = conquistasPorJogo[appID];
        const card = document.createElement("div");
        card.onclick = () => openGame(appID);

        const img = document.createElement("img");
        img.src = `https://cdn.cloudflare.steamstatic.com/steam/apps/${appID}/library_600x900.jpg`;

        const title = document.createElement("div");
        title.className = "game-title";
        title.textContent = jogo.game;

        card.appendChild(img);
        card.appendChild(title);
        gameView.appendChild(card);
	card.classList.add("game-card", "fade-in");
      }	
    }

    function openGame(appID) {
      gameView.style.display = "none";
      achievementView.style.display = "grid";
      backButton.style.display = "inline-block";
      achievementView.dataset.appID = appID;
      renderConquistas(appID);
    }

function renderConquistas(appID) {
  const jogo = conquistasPorJogo[appID];
  const container = achievementView;

  // Limpa tudo antes de renderizar novamente
  container.innerHTML = "";

  // Ordena as conquistas por tempo de chegada (mais recentes primeiro)
  const conquistasOrdenadas = [...jogo.conquistas].reverse(); 

  const conquistasRenderizadas = new Set();

  conquistasOrdenadas.forEach(data => {
    // Impede duplicatas (caso venham conquistas repetidas do WebSocket)
    if (conquistasRenderizadas.has(data.achievement)) return;
    conquistasRenderizadas.add(data.achievement);

    const box = document.createElement("div");
    box.className = "achievement fade-in";
    box.dataset.achievementId = data.achievement;

    const img = document.createElement("img");
    img.src = data.icon || "https://via.placeholder.com/64";

    const info = document.createElement("div");
    info.className = "achievement-info";

    const title = document.createElement("div");
title.className = "achievement-title";

let titleText = data.displayName;

if (data.progress) {
  const { current, max } = data.progress;
  const porcentagem = Math.floor((current / max) * 100);
  titleText += ` (${current}/${max} - ${porcentagem}%)`;
}

title.textContent = titleText;



    const desc = document.createElement("div");
    desc.className = "achievement-desc";
    desc.textContent = data.description || "Sem descriÃ§Ã£o";

    info.appendChild(title);
    info.appendChild(desc);

     if (data.progress) {
       const bar = document.createElement("div");
       bar.className = "progress-bar";
       const fill = document.createElement("div");
       fill.className = "progress-fill";
       fill.style.width = `${(data.progress.current / data.progress.max) * 100}%`;
       bar.appendChild(fill);
       info.appendChild(bar);
     }


    if (data.time) {
      const timestampDiv = document.createElement("div");
      timestampDiv.className = "achievement-timestamp";
      const date = new Date(data.time * 1000);
      timestampDiv.textContent = `ðŸ•’ Conquistado em: ${date.toLocaleString("pt-BR")}`;
      info.appendChild(timestampDiv);
    }

    box.appendChild(img);
    box.appendChild(info);
    container.appendChild(box);
  });
}


    backButton.onclick = () => {
      gameView.style.display = "grid";
      achievementView.style.display = "none";
      backButton.style.display = "none";
    };

  // Salvar conquistas localmente
  function salvarLocal() {
    localStorage.setItem("conquistas", JSON.stringify(conquistasPorJogo));
  }

  // Carregar conquistas ao iniciar
  function carregarLocal() {
    const salvo = localStorage.getItem("conquistas");
    if (salvo) {
      try {
        const data = JSON.parse(salvo);
        Object.assign(conquistasPorJogo, data);
        renderGames();
      } catch (e) {
        console.error("Erro ao carregar dados locais:", e);
      }
    }
  }

  // Exportar JSON
  document.getElementById("exportBtn").onclick = () => {
    const data = JSON.stringify(conquistasPorJogo, null, 2);
    const blob = new Blob([data], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "conquistas-backup.json";
    a.click();

    URL.revokeObjectURL(url);
  };

  // Importar JSON
  document.getElementById("importFile").addEventListener("change", function () {
    const file = this.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (event) {
      try {
        const data = JSON.parse(event.target.result);
        Object.assign(conquistasPorJogo, data);
        localStorage.setItem("conquistas", JSON.stringify(conquistasPorJogo));
        renderGames();
        alert("Conquistas importadas com sucesso!");
      } catch (e) {
        alert("Erro ao importar arquivo.");
      }
    };
    reader.readAsText(file);
  });

  // Chamar ao carregar a pÃ¡gina
  carregarLocal();

  </script>
</body>
</html>
